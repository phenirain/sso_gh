stages:
  - quality
  - build
  - test
  - functional_docs
  - functional_run

variables:
  GO_VERSION: "1.25"
  GOMODCACHE: "$CI_PROJECT_DIR/.cache/go/pkg/mod"
  GOCACHE: "$CI_PROJECT_DIR/.cache/go/build"


.default_go_job: &default_go_job
  tags:
    - asd
  image: "golang:${GO_VERSION}-alpine"
  before_script:
    - apk add --no-cache git bash
    - mkdir -p "$CI_PROJECT_DIR/ci-artifacts" "$GOMODCACHE" "$GOCACHE"
    - go env
    - go mod download
  cache:
    key: "${CI_PROJECT_NAME}-go"
    paths:
      - .cache/go/pkg/mod
      - .cache/go/build
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - ci-artifacts/

build:sso:
  stage: build
  <<: *default_go_job
  script:
    - mkdir -p dist
    - go build -o dist/sso ./cmd/sso 2>&1 | tee ci-artifacts/build.log
    - sha256sum dist/sso > ci-artifacts/sso.sha256
    - cp dist/sso ci-artifacts/sso-binary

test:go:
  stage: test
  <<: *default_go_job
  script:
    - go test ./... -count=1 2>&1 | tee ci-artifacts/go-test.log

lint:golangci:
  <<: *default_go_job
  stage: quality
  image: golangci/golangci-lint:v2.5.0-alpine
  script:
    - golangci-lint run --timeout=5m --output.tab.path=stdout 2>&1 | tee ci-artifacts/golangci-lint.log

functional:run-sso:
  stage: functional_run
  <<: *default_go_job
  script:
    - apk add --no-cache curl
    - cp config/config.yaml ci-artifacts/config.base.yaml
    - mkdir -p dist
    - go build -o dist/sso ./cmd/sso
    - ./dist/sso > ci-artifacts/sso-run.log 2>&1 &
    - SSO_PID=$!
    - |
      for i in $(seq 1 30); do
        if curl -fsS "http://127.0.0.1:8081/metrics" > /dev/null; then
          echo "SSO started successfully and /metrics is reachable" | tee ci-artifacts/sso-smoke.log
          break
        fi
        sleep 1
        if [ "$i" -eq 30 ]; then
          echo "SSO did not start or /metrics is unreachable" | tee ci-artifacts/sso-smoke.log
          exit 1
        fi
      done
    - kill "$SSO_PID" || true
    - wait "$SSO_PID" || true

functional:swagger-consistency:
  stage: functional_docs
  <<: *default_go_job
  script:
    - go install github.com/swaggo/swag/cmd/swag@v1.8.12
    - swag init -g cmd/sso/main.go -o docs --parseDependency --parseInternal 2>&1 | tee ci-artifacts/swagger-generate.log
    - |
      grep -vF 'LeftDelim: "{{"' docs/docs.go | \
      grep -vF 'RightDelim: "}}"' > docs/docs.go.tmp && \
      mv docs/docs.go.tmp docs/docs.go
    - git diff -- docs/docs.go docs/swagger.yaml docs/swagger.json > ci-artifacts/swagger.diff || true
    - |
      if [ -s ci-artifacts/swagger.diff ]; then
        echo "Swagger docs are outdated. Run 'make swagger_gen' and commit docs/* files." | tee -a ci-artifacts/swagger-generate.log
        exit 1
      fi
